#
# /etc/nginx/sites-enabled/ipo_visualizer_nginx.conf
#

# キャッシュ設定：IPOデータは基本的に変更されないため長期キャッシュを使用
proxy_cache_path /var/cache/nginx/ipo_visualizer levels=1:2 keys_zone=ipo_cache:100m max_size=50g inactive=365d use_temp_path=off;

server {
    # ポート80でHTTPリクエストを待ち受ける
    listen 80;
    listen [::]:80; # IPv6にも対応する場合

    # サーバー名 (IPアドレスやドメイン名でアクセスする場合。特に指定なければ _ でも可)
    server_name ipo_visualizer;

    location / {
        # キャッシュ設定
        proxy_cache ipo_cache;
        
        # 成功レスポンスは長期キャッシュ（1年）、エラーは短時間
        proxy_cache_valid 200 302 365d;
        proxy_cache_valid 404 500 502 503 504 1m;
        
        # 手動キャッシュ制御用
        proxy_cache_bypass $http_cache_control;
        proxy_no_cache $http_cache_control;
        
        # キャッシュ状態をレスポンスヘッダーに追加（デバッグ用）
        add_header X-Cache-Status $upstream_cache_status;
        
        # Flaskアプリ (127.0.0.1:5000) にリクエストを転送(プロキシ)
        proxy_pass http://127.0.0.1:5000;
        #proxy_pass http://0.0.0.0:5000;

        # リクエストヘッダーを適切に設定してFlaskアプリに渡す
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # /health エンドポイント（短時間キャッシュ）
    location /health {
        # ヘルスチェックは短時間のみキャッシュ
        proxy_cache ipo_cache;
        proxy_cache_valid 200 30s;
        proxy_cache_valid any 1s;
        
        add_header X-Cache-Status $upstream_cache_status;
        
        proxy_pass http://127.0.0.1:5000/health;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 管理者用キャッシュクリアエンドポイント
    location /admin/clear-cache {
        # アクセス制限（必要に応じてIP制限を追加）
        # allow 127.0.0.1;
        # deny all;
        
        proxy_cache_purge ipo_cache $scheme$proxy_host$request_uri;
        return 200 "Cache cleared successfully\n";
        add_header Content-Type text/plain;
    }

    # アクセスログとエラーログ (必要に応じて設定)
    access_log /var/log/nginx/ipo_visualizer.access.log;
    error_log /var/log/nginx/ipo_visualizer.error.log;
}
