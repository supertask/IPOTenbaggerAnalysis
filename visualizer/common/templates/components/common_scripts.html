<script>
    // ç«¶åˆä¼æ¥­ãƒ‡ãƒ¼ã‚¿ã‚’JavaScriptã§åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
    const competitorsData = {{ competitors|tojson|safe }};
    
    // ãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤ºé–¢æ•°
    function showToast(message) {
        const toastContainer = document.querySelector('.toast-container');
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.innerHTML = message;
        toastContainer.appendChild(toast);
        
        // è¡¨ç¤ºã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        setTimeout(() => {
            toast.classList.add('show');
        }, 10);
        
        // 3ç§’å¾Œã«éè¡¨ç¤º
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
                toastContainer.removeChild(toast);
            }, 300);
        }, 3000);
    }

    // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰APIãŒä½¿ãˆãªã„ç’°å¢ƒå‘ã‘ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    function openPromptWindow(text) {
        const newWin = window.open('', '_blank');
        if (!newWin) {
            alert('æ–°ã—ã„ã‚¿ãƒ–ã‚’é–‹ã‘ã¾ã›ã‚“ã§ã—ãŸã€‚ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ–ãƒ­ãƒƒã‚¯ã‚’è§£é™¤ã—ã¦ãã ã•ã„ã€‚');
            return;
        }
        const escaped = text
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;');
        newWin.document.write('<html><head><meta charset="utf-8"><title>Prompt</title></head><body style="white-space:pre-wrap;font-family:monospace;padding:20px;">' + escaped + '</body></html>');
        newWin.document.close();
    }

    // navigator.clipboard ãŒæœªå®šç¾©ã€ã¾ãŸã¯ writeText ãŒç„¡ã„å ´åˆã®ãƒãƒªãƒ•ã‚£ãƒ«
    if (!navigator.clipboard || !navigator.clipboard.writeText) {
        navigator.clipboard = {
            writeText: function(text) {
                openPromptWindow(text);
                return Promise.resolve();
            }
        };
    }
    
    // äº‹æ¥­ã®å†…å®¹ã®æ¯”è¼ƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹é–¢æ•°
    function copyBusinessComparisonPrompt() {
        var button = document.querySelector('.copy-button[onclick="copyBusinessComparisonPrompt()"]');
        
        // ãƒœã‚¿ãƒ³ã®å…ƒã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ä¿å­˜
        var originalHtml = button.innerHTML;
        
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã«å¤‰æ›´
        button.classList.add('loading');
        button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span><span class="loading-text">å‡¦ç†ä¸­...</span><span class="original-text">' + originalHtml + '</span>';
        
        // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆä¼æ¥­ã®äº‹æ¥­ã®å†…å®¹ã‚’å–å¾—
        var targetBusiness = document.querySelector('#target-company-business').textContent.trim();
        
        // ç«¶åˆä¼æ¥­ã®äº‹æ¥­ã®å†…å®¹ã‚’å–å¾—
        var competitorElements = document.querySelectorAll('[id^="competitor-business-"]:not([id$="-tab"])');
        var competitorInfo = Array.from(competitorElements).map(function(el) {
            return el.textContent.trim();
        });
        
        // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ã‚­ã‚¹ãƒˆã‚’ä½œæˆ
        var promptText = "ä¸‹è¨˜ã¯ã€ãã‚Œãã‚Œã®ä¼æ¥­ã®äº‹æ¥­ã®å†…å®¹ã§ã™ã€‚ãƒ†ãƒ³ãƒã‚¬ãƒ¼ã®ä¼æ¥­ã‚’é¸ã¶éš›ã«ã“ã‚Œã‚‰ã®äº‹æ¥­å†…å®¹ã ã‘ã®æƒ…å ±ã‹ã‚‰ã€ã©ã®ä¼šç¤¾ãŒä¼¸ã³ãã†ã ã¨æ€ã†ã‹äºˆæ¸¬ã—ç†ç”±ã‚’æ•™ãˆã¦\n\n";
        var companyName = '{{ company_name }}';
        var businessText = "ã€" + companyName + "ã®äº‹æ¥­ã®å†…å®¹ã€‘\n" + targetBusiness + "\n\n";
        
        // ç«¶åˆä¼æ¥­ã®æƒ…å ±ã‚’è¿½åŠ 
        var competitorsText = competitorInfo.map(function(info, index) {
            return "ã€" + competitorsData[index].name + "ã®äº‹æ¥­ã®å†…å®¹ã€‘\n" + info;
        }).join('\n\n');
        
        // å…¨ãƒ†ã‚­ã‚¹ãƒˆã‚’çµåˆ
        var fullText = promptText + businessText + competitorsText;

        // ç›´æ¥ã‚¿ãƒ–ã‚’é–‹ã
        openPromptWindow(fullText);
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã‚’è§£é™¤
        button.classList.remove('loading');
        // æˆåŠŸçŠ¶æ…‹ã«å¤‰æ›´
        button.classList.add('clicked');
        button.innerHTML = originalHtml;
        // ãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤º
        showToast('ã‚¿ãƒ–ã‚’é–‹ãã¾ã—ãŸï¼');
        setTimeout(function() {
            button.classList.remove('clicked');
            button.classList.add('recovering');
            setTimeout(function() {
                button.classList.remove('recovering');
            }, 500);
        }, 1000);
    }

    // å½¹å“¡æƒ…å ±ã®æ¯”è¼ƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹é–¢æ•°
    function copyOfficersComparisonPrompt() {
        var button = document.querySelector('.copy-button[onclick="copyOfficersComparisonPrompt()"]');
        
        // ãƒœã‚¿ãƒ³ã®å…ƒã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ä¿å­˜
        var originalHtml = button.innerHTML;
        
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã«å¤‰æ›´
        button.classList.add('loading');
        button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span><span class="loading-text">å‡¦ç†ä¸­...</span><span class="original-text">' + originalHtml + '</span>';
        
        // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆä¼æ¥­ã®å½¹å“¡æƒ…å ±ã‚’å–å¾—
        var targetOfficers = document.querySelector('#target-company').textContent.trim();
        
        // ç«¶åˆä¼æ¥­ã®å½¹å“¡æƒ…å ±ã‚’å–å¾—
        var competitorElements = document.querySelectorAll('[id^="competitor-"]:not([id$="-tab"]):not([id^="competitor-business-"])');
        var competitorInfo = Array.from(competitorElements).map(function(el) {
            return el.textContent.trim();
        });
        
        // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ã‚­ã‚¹ãƒˆã‚’ä½œæˆ
        var promptText = "ä¸‹è¨˜ã¯ã€ãã‚Œãã‚Œã®ä¼æ¥­ã®å½¹å“¡ã®çŠ¶æ³ã§ã™ã€‚ãƒ†ãƒ³ãƒã‚¬ãƒ¼ã®ä¼æ¥­ã‚’é¸ã¶éš›ã«ã“ã‚Œã‚‰ã®å½¹å“¡ã ã‘ã®æƒ…å ±ã‹ã‚‰ã€ã©ã®ä¼šç¤¾ãŒä¼¸ã³ãã†ã ã¨æ€ã†ã‹äºˆæ¸¬ã—ç†ç”±ã‚’æ•™ãˆã¦\n\n";
        var companyName = '{{ company_name }}';
        var officersText = "ã€" + companyName + "ã®å½¹å“¡ã®çŠ¶æ³ã€‘\n" + targetOfficers + "\n\n";
        
        // ç«¶åˆä¼æ¥­ã®æƒ…å ±ã‚’è¿½åŠ 
        var competitorsText = competitorInfo.map(function(info, index) {
            return "ã€" + competitorsData[index].name + "ã®å½¹å“¡ã®çŠ¶æ³ã€‘\n" + info;
        }).join('\n\n');
        
        // å…¨ãƒ†ã‚­ã‚¹ãƒˆã‚’çµåˆ
        var fullText = promptText + officersText + competitorsText;
        
        // ç›´æ¥ã‚¿ãƒ–ã‚’é–‹ã
        openPromptWindow(fullText);
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã‚’è§£é™¤
        button.classList.remove('loading');
        // æˆåŠŸçŠ¶æ…‹ã«å¤‰æ›´
        button.classList.add('clicked');
        button.innerHTML = originalHtml;
        // ãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤º
        showToast('ã‚¿ãƒ–ã‚’é–‹ãã¾ã—ãŸï¼');
        setTimeout(function() {
            button.classList.remove('clicked');
            button.classList.add('recovering');
            setTimeout(function() {
                button.classList.remove('recovering');
            }, 500);
        }, 1000);
    }
    
    // ChatGPTã§äº‹æ¥­ã®å†…å®¹ã®æ¯”è¼ƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’é–‹ãé–¢æ•°
    function openChatGPTWithBusinessPrompt() {
        // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆä¼æ¥­ã®äº‹æ¥­ã®å†…å®¹ã‚’å–å¾—
        var targetBusiness = document.querySelector('#target-company-business').textContent.trim();
        
        // ç«¶åˆä¼æ¥­ã®äº‹æ¥­ã®å†…å®¹ã‚’å–å¾—
        var competitorElements = document.querySelectorAll('[id^="competitor-business-"]:not([id$="-tab"])');
        var competitorInfo = Array.from(competitorElements).map(function(el) {
            return el.textContent.trim();
        });
        
        // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ã‚­ã‚¹ãƒˆã‚’ä½œæˆ
        var promptText = "ä¸‹è¨˜ã¯ã€ãã‚Œãã‚Œã®ä¼æ¥­ã®äº‹æ¥­ã®å†…å®¹ã§ã™ã€‚ãƒ†ãƒ³ãƒã‚¬ãƒ¼ã®ä¼æ¥­ã‚’é¸ã¶éš›ã«ã“ã‚Œã‚‰ã®äº‹æ¥­å†…å®¹ã ã‘ã®æƒ…å ±ã‹ã‚‰ã€ã©ã®ä¼šç¤¾ãŒä¼¸ã³ãã†ã ã¨æ€ã†ã‹äºˆæ¸¬ã—ç†ç”±ã‚’æ•™ãˆã¦\n\n";
        var companyName = '{{ company_name }}';
        var businessText = "ã€" + companyName + "ã®äº‹æ¥­ã®å†…å®¹ã€‘\n" + targetBusiness + "\n\n";
        
        // ç«¶åˆä¼æ¥­ã®æƒ…å ±ã‚’è¿½åŠ 
        var competitorsText = competitorInfo.map(function(info, index) {
            return "ã€" + competitorsData[index].name + "ã®äº‹æ¥­ã®å†…å®¹ã€‘\n" + info;
        }).join('\n\n');
        
        // å…¨ãƒ†ã‚­ã‚¹ãƒˆã‚’çµåˆ
        var fullText = promptText + businessText + competitorsText;
        
        // ChatGPTã‚’é–‹ã„ã¦æµ®å‹•ãƒœã‚¿ãƒ³ã‚’ä½œæˆ
        var chatWindow = window.open('https://chatgpt.com/', '_blank');
        
        // ãƒšãƒ¼ã‚¸ãŒèª­ã¿è¾¼ã¾ã‚Œã‚‹ã®ã‚’å¾…ã£ã¦ã‹ã‚‰æµ®å‹•ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
        setTimeout(function() {
            if (chatWindow && !chatWindow.closed) {
                try {
                    // æµ®ã‹ã›ã‚‹divè¦ç´ ã‚’ä½œæˆ
                    var toggleDiv = chatWindow.document.createElement("div");
                    toggleDiv.id = "floatingPromptDiv";
                    toggleDiv.style.position = "fixed";
                    toggleDiv.style.display = "flex";
                    toggleDiv.style.top = "20px";
                    toggleDiv.style.right = "20px";
                    toggleDiv.style.width = "60px";
                    toggleDiv.style.height = "60px";
                    toggleDiv.style.backgroundColor = "rgba(16, 163, 127, 0.9)";
                    toggleDiv.style.color = "white";
                    toggleDiv.style.borderRadius = "50%";
                    toggleDiv.style.alignItems = "center";
                    toggleDiv.style.justifyContent = "center";
                    toggleDiv.style.cursor = "pointer";
                    toggleDiv.style.zIndex = "10000";
                    toggleDiv.style.fontSize = "24px";
                    toggleDiv.innerHTML = "ğŸ“";
                    toggleDiv.title = "ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å…¥åŠ›";
                    
                    // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ 
                    toggleDiv.addEventListener("click", function() {
                        try {
                            // ChatGPTã®å…¥åŠ›æ¬„ã‚’ç‰¹å®š
                            var inputField = chatWindow.document.getElementById("prompt-textarea") || 
                                           chatWindow.document.querySelector(".ProseMirror") ||
                                           chatWindow.document.querySelector('textarea[placeholder*="Message"]') ||
                                           chatWindow.document.querySelector('div[contenteditable="true"]');
                            
                            if (inputField) {
                                // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’è¨­å®š
                                inputField.focus();
                                
                                if (inputField.tagName === 'TEXTAREA') {
                                    inputField.value = fullText;
                                    inputField.dispatchEvent(new Event("input", { bubbles: true }));
                                } else {
                                    inputField.textContent = fullText;
                                    inputField.dispatchEvent(new Event("input", { bubbles: true }));
                                }
                                
                                // ãƒœã‚¿ãƒ³ã‚’å‰Šé™¤
                                toggleDiv.remove();
                            } else {
                                alert("å…¥åŠ›æ¬„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ãƒšãƒ¼ã‚¸ãŒå®Œå…¨ã«èª­ã¿è¾¼ã¾ã‚Œã‚‹ã¾ã§ãŠå¾…ã¡ãã ã•ã„ã€‚");
                            }
                        } catch (error) {
                            console.error("ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå…¥åŠ›ã‚¨ãƒ©ãƒ¼:", error);
                            alert("ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®å…¥åŠ›ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
                        }
                    });
                    
                    // divã‚’ãƒšãƒ¼ã‚¸ã«è¿½åŠ 
                    chatWindow.document.body.appendChild(toggleDiv);
                } catch (error) {
                    console.error("æµ®å‹•ãƒœã‚¿ãƒ³ã®ä½œæˆã«å¤±æ•—:", error);
                }
            }
        }, 3000);
        
        // ãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤º
        showToast('ChatGPTã‚’é–‹ãã¾ã—ãŸï¼');
    }
    
    // ChatGPTã§å½¹å“¡ã®çŠ¶æ³ã®æ¯”è¼ƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’é–‹ãé–¢æ•°
    function openChatGPTWithOfficersPrompt() {
        // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆä¼æ¥­ã®å½¹å“¡æƒ…å ±ã‚’å–å¾—
        var targetOfficers = document.querySelector('#target-company').textContent.trim();
        
        // ç«¶åˆä¼æ¥­ã®å½¹å“¡æƒ…å ±ã‚’å–å¾—
        var competitorElements = document.querySelectorAll('[id^="competitor-"]:not([id$="-tab"]):not([id^="competitor-business-"])');
        var competitorInfo = Array.from(competitorElements).map(function(el) {
            return el.textContent.trim();
        });
        
        // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ã‚­ã‚¹ãƒˆã‚’ä½œæˆ
        var promptText = "ä¸‹è¨˜ã¯ã€ãã‚Œãã‚Œã®ä¼æ¥­ã®å½¹å“¡ã®çŠ¶æ³ã§ã™ã€‚ãƒ†ãƒ³ãƒã‚¬ãƒ¼ã®ä¼æ¥­ã‚’é¸ã¶éš›ã«ã“ã‚Œã‚‰ã®å½¹å“¡ã ã‘ã®æƒ…å ±ã‹ã‚‰ã€ã©ã®ä¼šç¤¾ãŒä¼¸ã³ãã†ã ã¨æ€ã†ã‹äºˆæ¸¬ã—ç†ç”±ã‚’æ•™ãˆã¦\n\n";
        var companyName = '{{ company_name }}';
        var officersText = "ã€" + companyName + "ã®å½¹å“¡ã®çŠ¶æ³ã€‘\n" + targetOfficers + "\n\n";
        
        // ç«¶åˆä¼æ¥­ã®æƒ…å ±ã‚’è¿½åŠ 
        var competitorsText = competitorInfo.map(function(info, index) {
            return "ã€" + competitorsData[index].name + "ã®å½¹å“¡ã®çŠ¶æ³ã€‘\n" + info;
        }).join('\n\n');
        
        // å…¨ãƒ†ã‚­ã‚¹ãƒˆã‚’çµåˆ
        var fullText = promptText + officersText + competitorsText;
        
        // ChatGPTã‚’é–‹ã„ã¦æµ®å‹•ãƒœã‚¿ãƒ³ã‚’ä½œæˆ
        var chatWindow = window.open('https://chatgpt.com/', '_blank');
        
        // ãƒšãƒ¼ã‚¸ãŒèª­ã¿è¾¼ã¾ã‚Œã‚‹ã®ã‚’å¾…ã£ã¦ã‹ã‚‰æµ®å‹•ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
        setTimeout(function() {
            if (chatWindow && !chatWindow.closed) {
                try {
                    // æµ®ã‹ã›ã‚‹divè¦ç´ ã‚’ä½œæˆ
                    var toggleDiv = chatWindow.document.createElement("div");
                    toggleDiv.id = "floatingPromptDiv";
                    toggleDiv.style.position = "fixed";
                    toggleDiv.style.display = "flex";
                    toggleDiv.style.top = "20px";
                    toggleDiv.style.right = "20px";
                    toggleDiv.style.width = "60px";
                    toggleDiv.style.height = "60px";
                    toggleDiv.style.backgroundColor = "rgba(16, 163, 127, 0.9)";
                    toggleDiv.style.color = "white";
                    toggleDiv.style.borderRadius = "50%";
                    toggleDiv.style.alignItems = "center";
                    toggleDiv.style.justifyContent = "center";
                    toggleDiv.style.cursor = "pointer";
                    toggleDiv.style.zIndex = "10000";
                    toggleDiv.style.fontSize = "24px";
                    toggleDiv.innerHTML = "ğŸ“";
                    toggleDiv.title = "ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å…¥åŠ›";
                    
                    // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ 
                    toggleDiv.addEventListener("click", function() {
                        try {
                            // ChatGPTã®å…¥åŠ›æ¬„ã‚’ç‰¹å®š
                            var inputField = chatWindow.document.getElementById("prompt-textarea") || 
                                           chatWindow.document.querySelector(".ProseMirror") ||
                                           chatWindow.document.querySelector('textarea[placeholder*="Message"]') ||
                                           chatWindow.document.querySelector('div[contenteditable="true"]');
                            
                            if (inputField) {
                                // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’è¨­å®š
                                inputField.focus();
                                
                                if (inputField.tagName === 'TEXTAREA') {
                                    inputField.value = fullText;
                                    inputField.dispatchEvent(new Event("input", { bubbles: true }));
                                } else {
                                    inputField.textContent = fullText;
                                    inputField.dispatchEvent(new Event("input", { bubbles: true }));
                                }
                                
                                // ãƒœã‚¿ãƒ³ã‚’å‰Šé™¤
                                toggleDiv.remove();
                            } else {
                                alert("å…¥åŠ›æ¬„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ãƒšãƒ¼ã‚¸ãŒå®Œå…¨ã«èª­ã¿è¾¼ã¾ã‚Œã‚‹ã¾ã§ãŠå¾…ã¡ãã ã•ã„ã€‚");
                            }
                        } catch (error) {
                            console.error("ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå…¥åŠ›ã‚¨ãƒ©ãƒ¼:", error);
                            alert("ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®å…¥åŠ›ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
                        }
                    });
                    
                    // divã‚’ãƒšãƒ¼ã‚¸ã«è¿½åŠ 
                    chatWindow.document.body.appendChild(toggleDiv);
                } catch (error) {
                    console.error("æµ®å‹•ãƒœã‚¿ãƒ³ã®ä½œæˆã«å¤±æ•—:", error);
                }
            }
        }, 3000);
        
        // ãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤º
        showToast('ChatGPTã‚’é–‹ãã¾ã—ãŸï¼');
    }
</script> 